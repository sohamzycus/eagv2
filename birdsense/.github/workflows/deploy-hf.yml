# Deploy to Hugging Face Spaces on push
# Triggers on push to main branch

name: Deploy to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'birdsense/**'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install huggingface_hub
        run: pip install huggingface_hub
      
      - name: Deploy to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd birdsense
          python << 'EOF'
          from huggingface_hub import HfApi, upload_folder
          import os
          
          api = HfApi(token=os.environ["HF_TOKEN"])
          
          # Create space if doesn't exist
          try:
              api.create_repo(
                  repo_id="sohiyiy/birdsense",
                  repo_type="space",
                  space_sdk="gradio",
                  private=False
              )
          except:
              pass  # Already exists
          
          # Upload files
          upload_folder(
              folder_path=".",
              repo_id="sohiyiy/birdsense",
              repo_type="space",
              token=os.environ["HF_TOKEN"],
              ignore_patterns=[
                  "__pycache__", "*.pyc", ".git*", "venv", 
                  "*.egg-info", "feedback_data", "*.zip"
              ]
          )
          print("âœ… Deployed to https://huggingface.co/spaces/sohiyiy/birdsense")
          EOF

