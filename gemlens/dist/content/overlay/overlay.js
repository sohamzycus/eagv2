var r=Object.defineProperty;var o=(n,t,e)=>t in n?r(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var s=(n,t,e)=>o(n,typeof t!="symbol"?t+"":t,e);class h{constructor(){s(this,"chatContainer");s(this,"chatInput");s(this,"sendBtn");s(this,"port",null);s(this,"messages",[]);s(this,"currentStreamingMessage",null);this.chatContainer=document.getElementById("chatContainer"),this.chatInput=document.getElementById("chatInput"),this.sendBtn=document.getElementById("sendBtn"),this.setupEventListeners(),this.connectToBackground()}setupEventListeners(){var t;(t=document.getElementById("closeOverlay"))==null||t.addEventListener("click",()=>{window.parent.postMessage({action:"closeOverlay"},"*")}),this.sendBtn.addEventListener("click",()=>{this.sendMessage()}),this.chatInput.addEventListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}),this.chatInput.addEventListener("input",()=>{this.chatInput.style.height="auto",this.chatInput.style.height=Math.min(this.chatInput.scrollHeight,100)+"px"})}connectToBackground(){this.port=chrome.runtime.connect({name:"gemini-stream"}),this.port.onMessage.addListener(t=>{t.type==="delta"?this.appendToStreamingMessage(t.chunk):t.type==="complete"?this.finishStreamingMessage():t.type==="error"&&this.showError(t.error)})}async sendMessage(){const t=this.chatInput.value.trim();if(t){this.addMessage("user",t),this.chatInput.value="",this.chatInput.style.height="auto",this.setInputEnabled(!1);try{const a=`Based on this webpage content: "${(await this.getPageContent()).text.substring(0,2e3)}...", please answer: ${t}`;this.startStreamingMessage(),this.port&&this.port.postMessage({action:"streamSummarize",text:a})}catch{this.showError("Failed to send message"),this.setInputEnabled(!0)}}}async getPageContent(){return new Promise(t=>{window.parent.postMessage({action:"getPageContent"},"*");const e=a=>{a.data.action==="pageContentResponse"&&(window.removeEventListener("message",e),t(a.data.content))};window.addEventListener("message",e),setTimeout(()=>{window.removeEventListener("message",e),t({text:"Page content not available",url:window.location.href})},1e3)})}addMessage(t,e){const a={role:t,content:e,timestamp:Date.now()};this.messages.push(a);const i=document.createElement("div");i.className=`message ${t}`,i.textContent=e,this.chatContainer.appendChild(i),this.scrollToBottom()}startStreamingMessage(){this.currentStreamingMessage=document.createElement("div"),this.currentStreamingMessage.className="message assistant streaming",this.chatContainer.appendChild(this.currentStreamingMessage),this.scrollToBottom()}appendToStreamingMessage(t){this.currentStreamingMessage&&(this.currentStreamingMessage.textContent+=t,this.scrollToBottom())}finishStreamingMessage(){if(this.currentStreamingMessage){this.currentStreamingMessage.classList.remove("streaming");const t=this.currentStreamingMessage.textContent||"";this.messages.push({role:"assistant",content:t,timestamp:Date.now()}),this.currentStreamingMessage=null}this.setInputEnabled(!0)}showError(t){const e=document.createElement("div");e.className="message assistant",e.textContent=`Sorry, I encountered an error: ${t}`,e.style.background="#FF3B30",e.style.color="white",this.chatContainer.appendChild(e),this.scrollToBottom(),this.setInputEnabled(!0)}setInputEnabled(t){this.chatInput.disabled=!t,this.sendBtn.disabled=!t}scrollToBottom(){this.chatContainer.scrollTop=this.chatContainer.scrollHeight}}document.addEventListener("DOMContentLoaded",()=>{new h});
