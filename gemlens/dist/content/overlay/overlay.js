var c=Object.defineProperty;var h=(i,e,t)=>e in i?c(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>h(i,typeof e!="symbol"?e+"":e,t);class g{constructor(){a(this,"chatContainer");a(this,"chatInput");a(this,"sendBtn");a(this,"port",null);a(this,"messages",[]);a(this,"currentStreamingMessage",null);a(this,"pageContext",null);this.chatContainer=document.getElementById("chatContainer"),this.chatInput=document.getElementById("chatInput"),this.sendBtn=document.getElementById("sendBtn"),this.setupEventListeners(),this.connectToBackground()}setupEventListeners(){var e;window.addEventListener("message",t=>{t.data.action==="setPageContext"&&(this.pageContext=t.data.content,console.log("Page context received:",this.pageContext))}),(e=document.getElementById("closeOverlay"))==null||e.addEventListener("click",()=>{if(window.parent!==window)window.parent.postMessage({action:"closeOverlay"},"*");else{const t=document.getElementById("gemlens-overlay");t&&t.remove()}}),this.sendBtn.addEventListener("click",()=>{this.sendMessage()}),this.chatInput.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.sendMessage())}),this.chatInput.addEventListener("input",()=>{this.chatInput.style.height="auto",this.chatInput.style.height=Math.min(this.chatInput.scrollHeight,100)+"px"})}connectToBackground(){try{this.port=chrome.runtime.connect({name:"gemini-stream"}),this.port.onMessage.addListener(e=>{e.type==="delta"?this.appendToStreamingMessage(e.chunk):e.type==="complete"?this.finishStreamingMessage():e.type==="error"&&this.showError(e.error)}),this.port.onDisconnect.addListener(()=>{console.log("Port disconnected, attempting to reconnect..."),setTimeout(()=>this.connectToBackground(),1e3)})}catch(e){console.error("Failed to connect to background:",e),this.port=null}}async sendMessage(){const e=this.chatInput.value.trim();if(e){this.addMessage("user",e),this.chatInput.value="",this.chatInput.style.height="auto",this.setInputEnabled(!1);try{let t="";this.pageContext?t=this.pageContext.text:t=(await this.getPageContent()).text;const n=`Based on this webpage content: "${t.substring(0,2e3)}...", please answer: ${e}`;if(this.startStreamingMessage(),this.port)this.port.postMessage({action:"streamSummarize",text:n});else try{const s=await chrome.runtime.sendMessage({action:"summarizePage",text:n});if(s!=null&&s.error)throw new Error(s.error);this.simulateStreaming(s.summary||"No response received")}catch(s){this.showError("Connection failed: "+s.message)}}catch(t){this.showError("Failed to send message: "+t.message),this.setInputEnabled(!0)}}}async getPageContent(){return new Promise(e=>{window.parent.postMessage({action:"getPageContent"},"*");const t=n=>{n.data.action==="pageContentResponse"&&(window.removeEventListener("message",t),e(n.data.content))};window.addEventListener("message",t),setTimeout(()=>{window.removeEventListener("message",t),e({text:"Page content not available",url:window.location.href})},1e3)})}addMessage(e,t){const n={role:e,content:t,timestamp:Date.now()};this.messages.push(n);const s=document.createElement("div");s.className=`message ${e}`,s.textContent=t,this.chatContainer.appendChild(s),this.scrollToBottom()}startStreamingMessage(){this.currentStreamingMessage=document.createElement("div"),this.currentStreamingMessage.className="message assistant streaming",this.chatContainer.appendChild(this.currentStreamingMessage),this.scrollToBottom()}appendToStreamingMessage(e){this.currentStreamingMessage&&(this.currentStreamingMessage.textContent+=e,this.scrollToBottom())}finishStreamingMessage(){if(this.currentStreamingMessage){this.currentStreamingMessage.classList.remove("streaming");const e=this.currentStreamingMessage.textContent||"";this.messages.push({role:"assistant",content:e,timestamp:Date.now()}),this.currentStreamingMessage=null}this.setInputEnabled(!0)}showError(e){const t=document.createElement("div");t.className="message assistant",t.textContent=`Sorry, I encountered an error: ${e}`,t.style.background="#FF3B30",t.style.color="white",this.chatContainer.appendChild(t),this.scrollToBottom(),this.setInputEnabled(!0)}setInputEnabled(e){this.chatInput.disabled=!e,this.sendBtn.disabled=!e}scrollToBottom(){this.chatContainer.scrollTop=this.chatContainer.scrollHeight}async simulateStreaming(e){const t=e.split(" "),n=3;for(let s=0;s<t.length;s+=n){const o=t.slice(s,s+n).join(" ")+" ";this.appendToStreamingMessage(o),await new Promise(r=>setTimeout(r,50))}this.finishStreamingMessage()}}document.addEventListener("DOMContentLoaded",()=>{new g});
